name: Create Microservice Release

on:
  push:
    tags:
      - '*-v*.*.*'  # Format: service-name-vX.Y.Z (e.g., ecommerce-platform-v1.0.0)

env:
  AWS_REGION: eu-west-1
  ECR_REGISTRY: 715841344657.dkr.ecr.eu-west-1.amazonaws.com
  ECR_REPOSITORY_PREFIX: infraforge-dev

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse tag and extract service info
        id: parse
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Full tag: $TAG"

          # Parse service-name-vX.Y.Z
          SERVICE_NAME=$(echo "$TAG" | sed -E 's/-v[0-9]+\.[0-9]+\.[0-9]+$//')
          VERSION=$(echo "$TAG" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+$')

          echo "service-name=${SERVICE_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "image=${ECR_REGISTRY}/${ECR_REPOSITORY_PREFIX}/${SERVICE_NAME}:${VERSION}" >> $GITHUB_OUTPUT

          echo "Service: $SERVICE_NAME"
          echo "Version: $VERSION"

      - name: Verify service directory exists
        run: |
          if [ ! -d "microservices/${{ steps.parse.outputs.service-name }}" ]; then
            echo "Error: microservices/${{ steps.parse.outputs.service-name }} does not exist"
            exit 1
          fi

      - name: Generate changelog
        id: changelog
        run: |
          SERVICE_NAME="${{ steps.parse.outputs.service-name }}"

          # Get previous tag for this service
          PREV_TAG=$(git tag -l "${SERVICE_NAME}-v*" --sort=-version:refname | grep -v "^${GITHUB_REF#refs/tags/}$" | head -n1 || echo "")

          echo "## Changes in ${{ steps.parse.outputs.version }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          if [ -n "$PREV_TAG" ]; then
            echo "Changes since ${PREV_TAG}:" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges -- "microservices/${SERVICE_NAME}" >> CHANGELOG.md || echo "- Initial release" >> CHANGELOG.md
          else
            echo "- Initial release" >> CHANGELOG.md
          fi

          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Release Info" >> CHANGELOG.md
          echo "- **Service**: ${SERVICE_NAME}" >> CHANGELOG.md
          echo "- **Version**: ${{ steps.parse.outputs.version }}" >> CHANGELOG.md
          echo "- **Image**: ${{ steps.parse.outputs.image }}" >> CHANGELOG.md
          echo "- **Commit**: ${GITHUB_SHA}" >> CHANGELOG.md
          echo "- **Build Date**: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> CHANGELOG.md

          cat CHANGELOG.md

      - name: Create release metadata file
        run: |
          cat > release-info.yaml <<EOF
          # Release Information for ${{ steps.parse.outputs.service-name }}
          apiVersion: v1
          kind: ReleaseInfo
          metadata:
            name: ${{ steps.parse.outputs.service-name }}
            version: ${{ steps.parse.outputs.version }}
            tag: ${{ steps.parse.outputs.tag }}
          spec:
            image: ${{ steps.parse.outputs.image }}
            commit: ${GITHUB_SHA}
            buildDate: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
            repository: ${{ github.repository }}

          # ApplicationClaim Example
          # Use this version in your ApplicationClaim:
          #
          # apiVersion: platform.infraforge.io/v1alpha1
          # kind: ApplicationClaim
          # metadata:
          #   name: my-${{ steps.parse.outputs.service-name }}
          # spec:
          #   type: microservice
          #   name: my-app
          #   version: "${{ steps.parse.outputs.version }}"
          #   image: "${{ steps.parse.outputs.image }}"
          #   replicas: 2
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.parse.outputs.tag }}
          name: ${{ steps.parse.outputs.service-name }} ${{ steps.parse.outputs.version }}
          body_path: CHANGELOG.md
          files: |
            release-info.yaml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release info
        run: |
          echo "âœ… Release created successfully!"
          echo ""
          echo "Service: ${{ steps.parse.outputs.service-name }}"
          echo "Version: ${{ steps.parse.outputs.version }}"
          echo "Image: ${{ steps.parse.outputs.image }}"
          echo ""
          echo "To deploy this version, create an ApplicationClaim with:"
          echo "  version: ${{ steps.parse.outputs.version }}"
          echo "  image: ${{ steps.parse.outputs.image }}"
