name: Build and Push Microservices

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'microservices/**'
      - '.github/workflows/build-microservices.yml'
  pull_request:
    paths:
      - 'microservices/**'
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1
  ECR_REGISTRY: 715841344657.dkr.ecr.eu-west-1.amazonaws.com
  ECR_REPOSITORY_PREFIX: infraforge-dev

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      product-service: ${{ steps.changes.outputs.product-service }}
      user-service: ${{ steps.changes.outputs.user-service }}
      order-service: ${{ steps.changes.outputs.order-service }}
      payment-service: ${{ steps.changes.outputs.payment-service }}
      notification-service: ${{ steps.changes.outputs.notification-service }}
      ecommerce-platform: ${{ steps.changes.outputs.ecommerce-platform }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            product-service:
              - 'microservices/product-service/**'
            user-service:
              - 'microservices/user-service/**'
            order-service:
              - 'microservices/order-service/**'
            payment-service:
              - 'microservices/payment-service/**'
            notification-service:
              - 'microservices/notification-service/**'
            ecommerce-platform:
              - 'microservices/ecommerce-platform/**'

  build-and-push:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.product-service == 'true' ||
      needs.detect-changes.outputs.user-service == 'true' ||
      needs.detect-changes.outputs.order-service == 'true' ||
      needs.detect-changes.outputs.payment-service == 'true' ||
      needs.detect-changes.outputs.notification-service == 'true' ||
      needs.detect-changes.outputs.ecommerce-platform == 'true' ||
      github.event_name == 'workflow_dispatch'

    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - product-service
          - user-service
          - order-service
          - payment-service
          - notification-service
          - ecommerce-platform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if service changed
        id: should-build
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "build=true" >> $GITHUB_OUTPUT
          elif [ "${{ needs.detect-changes.outputs[matrix.service] }}" == "true" ]; then
            echo "build=true" >> $GITHUB_OUTPUT
          else
            echo "build=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        if: steps.should-build.outputs.build == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        if: steps.should-build.outputs.build == 'true'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        if: steps.should-build.outputs.build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        if: steps.should-build.outputs.build == 'true'
        id: meta
        run: |
          SERVICE_NAME=${{ matrix.service }}
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)

          echo "service-name=${SERVICE_NAME}" >> $GITHUB_OUTPUT
          echo "image-tag-latest=${ECR_REGISTRY}/${ECR_REPOSITORY_PREFIX}/${SERVICE_NAME}:latest" >> $GITHUB_OUTPUT
          echo "image-tag-sha=${ECR_REGISTRY}/${ECR_REPOSITORY_PREFIX}/${SERVICE_NAME}:${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "image-tag-v1=${ECR_REGISTRY}/${ECR_REPOSITORY_PREFIX}/${SERVICE_NAME}:v1.0.0" >> $GITHUB_OUTPUT
          echo "image-tag-timestamp=${ECR_REGISTRY}/${ECR_REPOSITORY_PREFIX}/${SERVICE_NAME}:${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        if: steps.should-build.outputs.build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./microservices/${{ matrix.service }}
          platforms: linux/amd64
          push: true
          tags: |
            ${{ steps.meta.outputs.image-tag-latest }}
            ${{ steps.meta.outputs.image-tag-sha }}
            ${{ steps.meta.outputs.image-tag-v1 }}
            ${{ steps.meta.outputs.image-tag-timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image digest
        if: steps.should-build.outputs.build == 'true'
        run: |
          echo "Built and pushed: ${{ steps.meta.outputs.image-tag-latest }}"
          echo "Tags: latest, ${{ github.sha }}, v1.0.0"
