name: Build and Push Microservices

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'microservices/**'
      - '.github/workflows/build-microservices.yml'
    tags:
      - '*-v*.*.*'  # Build on tags too
  pull_request:
    paths:
      - 'microservices/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      product-service: ${{ steps.changes.outputs.product-service }}
      user-service: ${{ steps.changes.outputs.user-service }}
      order-service: ${{ steps.changes.outputs.order-service }}
      payment-service: ${{ steps.changes.outputs.payment-service }}
      notification-service: ${{ steps.changes.outputs.notification-service }}
      ecommerce-platform: ${{ steps.changes.outputs.ecommerce-platform }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            product-service:
              - 'microservices/product-service/**'
            user-service:
              - 'microservices/user-service/**'
            order-service:
              - 'microservices/order-service/**'
            payment-service:
              - 'microservices/payment-service/**'
            notification-service:
              - 'microservices/notification-service/**'
            ecommerce-platform:
              - 'microservices/ecommerce-platform/**'

  build-and-push:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.product-service == 'true' ||
      needs.detect-changes.outputs.user-service == 'true' ||
      needs.detect-changes.outputs.order-service == 'true' ||
      needs.detect-changes.outputs.payment-service == 'true' ||
      needs.detect-changes.outputs.notification-service == 'true' ||
      needs.detect-changes.outputs.ecommerce-platform == 'true' ||
      github.event_name == 'workflow_dispatch'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        service:
          - product-service
          - user-service
          - order-service
          - payment-service
          - notification-service
          - ecommerce-platform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if service changed
        id: should-build
        run: |
          # If this is a tag push, check if tag matches this service
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            SERVICE_FROM_TAG=$(echo "$TAG_NAME" | sed -E 's/-v[0-9]+\.[0-9]+\.[0-9]+$//')

            if [ "$SERVICE_FROM_TAG" == "${{ matrix.service }}" ]; then
              echo "build=true" >> $GITHUB_OUTPUT
              echo "Building ${{ matrix.service }} from tag ${TAG_NAME}"
            else
              echo "build=false" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "build=true" >> $GITHUB_OUTPUT
          elif [ "${{ needs.detect-changes.outputs[matrix.service] }}" == "true" ]; then
            echo "build=true" >> $GITHUB_OUTPUT
          else
            echo "build=false" >> $GITHUB_OUTPUT
          fi

      - name: Login to GitHub Container Registry
        if: steps.should-build.outputs.build == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        if: steps.should-build.outputs.build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        if: steps.should-build.outputs.build == 'true'
        id: meta
        run: |
          SERVICE_NAME=${{ matrix.service }}
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)

          # Convert repository owner to lowercase for GHCR
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          # Check if this is a tag push
          TAGS="ghcr.io/${OWNER_LC}/${SERVICE_NAME}:latest"
          TAGS="${TAGS}\nghcr.io/${OWNER_LC}/${SERVICE_NAME}:${SHORT_SHA}"
          TAGS="${TAGS}\nghcr.io/${OWNER_LC}/${SERVICE_NAME}:${TIMESTAMP}"

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            # Extract version from tag (format: service-name-vX.Y.Z)
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            VERSION=$(echo "$TAG_NAME" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+$')
            TAG_SERVICE=$(echo "$TAG_NAME" | sed -E 's/-v[0-9]+\.[0-9]+\.[0-9]+$//')

            # Only add version tag if this tag is for this service
            if [ "$TAG_SERVICE" == "$SERVICE_NAME" ]; then
              TAGS="${TAGS}\nghcr.io/${OWNER_LC}/${SERVICE_NAME}:${VERSION}"
              echo "Building release version: ${VERSION}"
            fi
          fi

          echo "service-name=${SERVICE_NAME}" >> $GITHUB_OUTPUT
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo -e "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        if: steps.should-build.outputs.build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./microservices/${{ matrix.service }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image digest
        if: steps.should-build.outputs.build == 'true'
        run: |
          echo "âœ… Built and pushed: ${{ steps.meta.outputs.service-name }}"
          echo ""
          echo "Tags:"
          echo "${{ steps.meta.outputs.tags }}"
