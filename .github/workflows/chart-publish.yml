name: Publish Helm Charts to OCI

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/chart-publish.yml'

permissions:
  contents: read
  packages: write

jobs:
  publish:
    name: Package & Publish Charts to GitHub Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            --username ${{ github.actor }} \
            --password-stdin

      - name: Extract repository metadata
        id: meta
        run: |
          # Get repository owner (lowercase for OCI compatibility)
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner=$OWNER" >> $GITHUB_OUTPUT

          # Generate timestamp
          BUILD_DATE=$(date +%Y%m%d%H%M%S)
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

          echo "ðŸ·ï¸  Owner: $OWNER"

      - name: Package & Publish Charts
        run: |
          OWNER="${{ steps.meta.outputs.owner }}"
          mkdir -p .helm-packages

          for chart_dir in charts/*/; do
            chart_name=$(basename "$chart_dir")

            # Extract version from individual chart
            VERSION=$(grep '^version:' "${chart_dir}/Chart.yaml" | awk '{print $2}')

            echo "ðŸ“¦ Packaging chart: $chart_name (version: $VERSION)"

            # Package the chart
            helm package "$chart_dir" --destination .helm-packages

            echo "ðŸš€ Pushing $chart_name:$VERSION to OCI registry..."

            # Push to GitHub Container Registry
            helm push ".helm-packages/${chart_name}-${VERSION}.tgz" "oci://ghcr.io/${OWNER}"

            echo "âœ… Published: oci://ghcr.io/${OWNER}/${chart_name}:${VERSION}"
            echo ""
          done

      # Note: Each chart has its own version in Chart.yaml
      # Helm OCI doesn't support "latest" as a version tag

      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release-notes.md << EOF
          ## Helm Charts Published ðŸ“¦

          **Build Date:** ${{ steps.meta.outputs.build_date }}

          ### Published Charts

          EOF

          for chart_dir in charts/*/; do
            chart_name=$(basename "$chart_dir")
            VERSION=$(grep '^version:' "${chart_dir}/Chart.yaml" | awk '{print $2}')
            echo "- \`oci://ghcr.io/${{ steps.meta.outputs.owner }}/${chart_name}:${VERSION}\`" >> release-notes.md
          done

          cat >> release-notes.md << EOF

          ### Usage

          \`\`\`bash
          # Pull specific chart
          helm pull oci://ghcr.io/${{ steps.meta.outputs.owner }}/microservice --version 1.0.0

          # Install
          helm install my-app oci://ghcr.io/${{ steps.meta.outputs.owner }}/microservice --version 1.0.0
          \`\`\`

          ### Platform Operator Usage

          \`\`\`yaml
          apiVersion: platform.infraforge.io/v1
          kind: BootstrapClaim
          spec:
            chartsRepository:
              type: oci
              url: oci://ghcr.io/${{ steps.meta.outputs.owner }}/microservice
              version: "1.0.0"
          \`\`\`

          ---
          ðŸ¤– Auto-published by GitHub Actions
          EOF

          cat release-notes.md

      - name: Cleanup
        if: always()
        run: |
          helm registry logout ghcr.io
          rm -rf .helm-packages /tmp/*.tgz
