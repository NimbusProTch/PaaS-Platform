name: Helm Chart Lint

on:
  pull_request:
    paths:
      - 'charts/**'
      - '.github/workflows/chart-lint.yml'

jobs:
  lint:
    name: Lint Helm Charts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Run chart-testing (lint)
        run: |
          ct lint \
            --config .github/ct.yaml \
            --chart-dirs charts \
            --all

      - name: Helm Template Test
        run: |
          for chart in charts/*/; do
            chart_name=$(basename "$chart")
            echo "Testing chart: $chart_name"

            # Test microservice type
            helm template test-app "$chart" \
              --set type=microservice \
              --set image.repository=test \
              --set image.tag=latest \
              --debug

            # Test PostgreSQL type
            helm template test-db "$chart" \
              --set type=postgresql \
              --set postgresql.instances=3 \
              --debug
          done

      - name: Validate YAML
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: charts/
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
                level: warning
              indentation:
                spaces: 2

      - name: Check Chart Version
        run: |
          for chart in charts/*/Chart.yaml; do
            version=$(grep '^version:' "$chart" | awk '{print $2}')
            echo "Chart version: $version"

            # Semantic versioning check
            if ! [[ $version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "❌ Invalid semantic version: $version"
              exit 1
            fi
            echo "✅ Valid semantic version: $version"
          done
