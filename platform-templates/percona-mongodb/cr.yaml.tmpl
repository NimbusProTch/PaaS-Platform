# Percona Server for MongoDB Custom Resource Template
# InfraForge Platform - Enterprise MongoDB Deployment
# Profile: {{ .Profile }} (dev/standard/production)
apiVersion: psmdb.percona.com/v1
kind: PerconaServerMongoDB
metadata:
  name: {{ .Name }}
  namespace: {{ .Namespace }}
  labels:
    infraforge.io/tenant: {{ .Tenant }}
    infraforge.io/environment: {{ .Environment }}
    infraforge.io/profile: {{ .Profile }}
    infraforge.io/managed-by: kratix
  annotations:
    argocd.argoproj.io/sync-wave: "30"
  finalizers:
    - percona.com/delete-psmdb-pods-in-order
spec:
  # Platform and pause settings
  platform: kubernetes
  pause: false
  unmanaged: false
  
  # CR version for compatibility
  crVersion: 1.15.0
  
  # MongoDB image
  image: percona/percona-server-mongodb:7.0.8-5
  imagePullPolicy: IfNotPresent
  {{- if .ImagePullSecrets }}
  imagePullSecrets:
  {{- range .ImagePullSecrets }}
    - name: {{ . }}
  {{- end }}
  {{- end }}
  
  # Init container image
  initImage: percona/percona-server-mongodb-operator:1.15.0
  
  # Update strategy
  updateStrategy: SmartUpdate
  upgradeOptions:
    versionServiceEndpoint: https://check.percona.com
    apply: {{ if eq .Profile "production" }}4.4-never{{ else }}disabled{{ end }}
    schedule: "0 2 * * *"
    setFCV: false
  
  # Security settings
  {{- if eq .Profile "production" }}
  unsafeFlags:
    tls: false
    replsetSize: false
    mongosSize: false
    terminationGracePeriod: false
    backupIfUnhealthy: true
  {{- end }}
  
  # Secrets configuration
  secrets:
    users: {{ .Name }}-users-secret
    {{- if eq .Profile "production" }}
    encryptionKey: {{ .Name }}-encryption-key
    {{- end }}
  
  # Replica Set Configuration
  replsets:
  - name: rs0
    # Size by profile
    {{- if eq .Profile "dev" }}
    size: 1
    {{- else if eq .Profile "standard" }}
    size: 3
    {{- else if eq .Profile "production" }}
    size: 5
    {{- end }}
    
    # Anti-affinity for HA
    {{- if ne .Profile "dev" }}
    affinity:
      antiAffinityTopologyKey: "kubernetes.io/hostname"
    {{- end }}
    
    # Pod disruption budget
    {{- if eq .Profile "production" }}
    podDisruptionBudget:
      minAvailable: 3
    {{- else if eq .Profile "standard" }}
    podDisruptionBudget:
      minAvailable: 2
    {{- end }}
    
    # Arbiter (for even numbers)
    arbiter:
      enabled: false
      size: 0
    
    # Resources by profile
    resources:
      limits:
        {{- if eq .Profile "dev" }}
        cpu: "1"
        memory: 2Gi
        {{- else if eq .Profile "standard" }}
        cpu: "2"
        memory: 4Gi
        {{- else if eq .Profile "production" }}
        cpu: "4"
        memory: 8Gi
        {{- end }}
      requests:
        {{- if eq .Profile "dev" }}
        cpu: 500m
        memory: 1Gi
        {{- else if eq .Profile "standard" }}
        cpu: "1"
        memory: 2Gi
        {{- else if eq .Profile "production" }}
        cpu: "2"
        memory: 4Gi
        {{- end }}
    
    # Storage configuration
    volumeSpec:
      persistentVolumeClaim:
        {{- if eq .Profile "dev" }}
        storageClassName: standard
        {{- else }}
        storageClassName: fast-ssd
        {{- end }}
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            {{- if eq .Profile "dev" }}
            storage: 10Gi
            {{- else if eq .Profile "standard" }}
            storage: 50Gi
            {{- else if eq .Profile "production" }}
            storage: 200Gi
            {{- end }}
    
    # MongoDB configuration
    configuration: |
      {{- if eq .Profile "dev" }}
      operationProfiling:
        mode: off
      {{- else }}
      operationProfiling:
        mode: slowOp
        slowOpThresholdMs: {{ if eq .Profile "standard" }}100{{ else }}50{{ end }}
        filter: '{ "op": { "$nin": [ "command", "query", "update", "insert", "getMore", "delete" ] } }'
      {{- end }}
      storage:
        engine: wiredTiger
        directoryPerDB: {{ if eq .Profile "production" }}true{{ else }}false{{ end }}
        wiredTiger:
          engineConfig:
            {{- if eq .Profile "dev" }}
            cacheSizeGB: 0.5
            {{- else if eq .Profile "standard" }}
            cacheSizeGB: 2
            {{- else if eq .Profile "production" }}
            cacheSizeGB: 4
            {{- end }}
            journalCompressor: {{ if eq .Profile "production" }}zstd{{ else }}snappy{{ end }}
            directoryForIndexes: {{ if eq .Profile "production" }}true{{ else }}false{{ end }}
          collectionConfig:
            blockCompressor: {{ if eq .Profile "production" }}zstd{{ else }}snappy{{ end }}
          indexConfig:
            prefixCompression: true
      net:
        port: 27017
        bindIpAll: true
        {{- if eq .Profile "dev" }}
        maxIncomingConnections: 1000
        {{- else if eq .Profile "standard" }}
        maxIncomingConnections: 10000
        {{- else if eq .Profile "production" }}
        maxIncomingConnections: 65536
        {{- end }}
        {{- if eq .Profile "production" }}
        compression:
          compressors: snappy,zstd,zlib
        {{- end }}
        # Connection pool settings
        unixDomainSocket:
          enabled: true
        serviceExecutor: adaptive
      {{- if ne .Profile "dev" }}
      replication:
        enableMajorityReadConcern: true
        oplogSizeMB: {{ if eq .Profile "standard" }}5120{{ else }}10240{{ end }}
      {{- end }}
      {{- if eq .Profile "production" }}
      security:
        enableEncryption: true
        encryptionKeyFile: /etc/mongodb-encryption/encryption-key
        redactClientLogData: true
      setParameter:
        ttlMonitorSleepSecs: 60
        wiredTigerConcurrentReadTransactions: 128
        wiredTigerConcurrentWriteTransactions: 128
        transactionLifetimeLimitSeconds: 300
        maxIndexBuildMemoryUsageMegabytes: 500
      {{- end }}
    
    # Non-voting members for production read scaling
    {{- if eq .Profile "production" }}
    nonvoting:
      enabled: true
      size: 2
      resources:
        limits:
          cpu: "2"
          memory: 4Gi
        requests:
          cpu: "1"
          memory: 2Gi
      configuration: |
        operationProfiling:
          mode: off
        storage:
          engine: wiredTiger
          wiredTiger:
            engineConfig:
              cacheSizeGB: 2
    {{- end }}
    
    # Readiness/Liveness probes
    readinessProbe:
      failureThreshold: {{ if eq .Profile "production" }}8{{ else }}3{{ end }}
      initialDelaySeconds: {{ if eq .Profile "production" }}60{{ else }}30{{ end }}
      periodSeconds: {{ if eq .Profile "production" }}30{{ else }}10{{ end }}
      successThreshold: 1
      timeoutSeconds: 10
    livenessProbe:
      failureThreshold: {{ if eq .Profile "production" }}6{{ else }}3{{ end }}
      initialDelaySeconds: {{ if eq .Profile "production" }}90{{ else }}60{{ end }}
      periodSeconds: {{ if eq .Profile "production" }}30{{ else }}20{{ end }}
      timeoutSeconds: 10
    
    # Sidecar containers for production
    {{- if eq .Profile "production" }}
    sidecars:
    - name: log-aggregator
      image: busybox:1.36
      command: ["/bin/sh"]
      args:
        - -c
        - |
          tail -n 0 -F /var/log/mongodb/mongod.log | while read line; do
            echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) $line"
          done
      volumeMounts:
      - name: mongod-logs
        mountPath: /var/log/mongodb
    {{- end }}

  # Sharding Configuration (Production only)
  sharding:
    {{- if eq .Profile "production" }}
    enabled: true
    configsvrReplSet:
      size: 3
      resources:
        limits:
          cpu: "1"
          memory: 2Gi
        requests:
          cpu: 500m
          memory: 1Gi
      volumeSpec:
        persistentVolumeClaim:
          storageClassName: fast-ssd
          resources:
            requests:
              storage: 20Gi
    
    mongos:
      size: 3
      expose:
        exposeType: ClusterIP
      resources:
        limits:
          cpu: "1"
          memory: 1Gi
        requests:
          cpu: 500m
          memory: 512Mi
      configuration: |
        net:
          maxIncomingConnections: 30000
          serviceExecutor: adaptive
        setParameter:
          taskExecutorPoolSize: 10
    {{- else }}
    enabled: false
    {{- end }}

  # Backup Configuration
  backup:
    {{- if eq .Profile "dev" }}
    enabled: false
    {{- else }}
    enabled: true
    image: percona/percona-backup-mongodb:2.3.0
    
    # Service Account
    serviceAccountName: {{ .Name }}-backup
    
    # Backup storages
    storages:
      {{- if eq .Profile "standard" }}
      minio-backup:
        type: s3
        s3:
          bucket: mongodb-backups
          region: us-east-1
          prefix: {{ .Tenant }}/{{ .Environment }}/{{ .Name }}
          endpointUrl: http://infraforge-minio.infraforge-storage:9000
          credentialsSecret: {{ .Name }}-backup-minio
          insecureSkipTLSVerify: true
      {{- else if eq .Profile "production" }}
      minio-primary:
        type: s3
        s3:
          bucket: mongodb-backups-prod
          region: us-east-1
          prefix: {{ .Tenant }}/{{ .Environment }}/{{ .Name }}
          endpointUrl: http://infraforge-minio.infraforge-storage:9000
          credentialsSecret: {{ .Name }}-backup-minio
          serverSideEncryption:
            sseAlgorithm: AES256
            kmsKeyID: {{ .Name }}-kms-key
          insecureSkipTLSVerify: false
      nfs-secondary:
        type: filesystem
        filesystem:
          persistentVolumeClaim:
            storageClassName: nfs-backup
            accessModes: ["ReadWriteMany"]
            resources:
              requests:
                storage: 500Gi
      {{- end }}
    
    # PITR for production
    {{- if eq .Profile "production" }}
    pitr:
      enabled: true
      oplogOnly: false
      oplogSpanMin: 60
      compressionType: zstd
      compressionLevel: 6
    {{- end }}
    
    # Backup tasks
    tasks:
      {{- if eq .Profile "standard" }}
      - name: daily-backup
        enabled: true
        schedule: "0 2 * * *"
        keep: 7
        storageName: minio-backup
        compressionType: gzip
        compressionLevel: 6
      - name: weekly-backup
        enabled: true
        schedule: "0 3 * * 0"
        keep: 4
        storageName: minio-backup
        compressionType: gzip
        compressionLevel: 9
      {{- else if eq .Profile "production" }}
      - name: incremental-30min
        enabled: true
        schedule: "*/30 * * * *"
        keep: 48
        storageName: minio-primary
        type: incremental
        compressionType: zstd
        compressionLevel: 6
      - name: daily-full
        enabled: true
        schedule: "0 2 * * *"
        keep: 7
        storageName: minio-primary
        type: full
        compressionType: zstd
        compressionLevel: 9
      - name: weekly-nfs
        enabled: true
        schedule: "0 3 * * 0"
        keep: 8
        storageName: nfs-secondary
        type: full
        compressionType: zstd
        compressionLevel: 9
      - name: monthly-archive
        enabled: true
        schedule: "0 4 1 * *"
        keep: 12
        storageName: minio-primary
        type: full
        compressionType: zstd
        compressionLevel: 9
      {{- end }}
    {{- end }}

  # PMM Monitoring
  pmm:
    {{- if eq .Profile "dev" }}
    enabled: false
    {{- else }}
    enabled: true
    image: percona/pmm-client:2.40.0
    serverHost: pmm-server.infraforge-monitoring
    {{- if eq .Profile "production" }}
    resources:
      limits:
        cpu: 600m
        memory: 600Mi
      requests:
        cpu: 300m
        memory: 300Mi
    # Advanced monitoring settings for production
    args:
      - "--disable-tablestats-limit=2000"
      - "--disable-queryexamples=false"
      - "--query-source=profiler"
      - "--disable-collectors="
      - "--max-query-length=2048"
      - "--max-slowlog-size=1073741824"  # 1GB
    {{- else }}
    resources:
      limits:
        cpu: 500m
        memory: 500Mi
      requests:
        cpu: 200m
        memory: 200Mi
    {{- end }}
    {{- end }}

  # TLS Configuration
  tls:
    {{- if eq .Profile "dev" }}
    # Disabled for dev
    mode: disabled
    {{- else if eq .Profile "standard" }}
    mode: preferTLS
    certValidityDuration: 8760h  # 1 year
    {{- else if eq .Profile "production" }}
    mode: requireTLS
    certValidityDuration: 8760h  # 1 year
    issuerConf:
      name: {{ .Name }}-ca-issuer
      kind: Issuer
      group: cert-manager.io
    {{- end }}

{{- if eq .Profile "production" }}
---
# Production: Encryption Key Secret
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Name }}-encryption-key
  namespace: {{ .Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "25"
type: Opaque
data:
  # This should be generated and stored securely in production
  # Base64 encoded encryption key - should be generated and stored securely in production
  encryption-key: Q0hBTkdFTUVfVVNFX1JFQUxfS0VZX0lOX1BST0RVQ1RJT04=
{{- end }}