{{- if eq .Values.type "postgresql" }}
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ include "common.fullname" . }}
  labels:
    {{- include "common.labels" . | nindent 4 }}
  {{- with .Values.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  instances: {{ .Values.postgresql.instances | default 3 }}

  postgresql:
    parameters:
      max_connections: {{ .Values.postgresql.maxConnections | default "200" | quote }}
      shared_buffers: {{ .Values.postgresql.sharedBuffers | default "256MB" | quote }}
      effective_cache_size: {{ .Values.postgresql.effectiveCacheSize | default "1GB" | quote }}
      work_mem: {{ .Values.postgresql.workMem | default "4MB" | quote }}
    pg_hba:
      - host all all all md5

  bootstrap:
    initdb:
      database: {{ .Values.postgresql.database | default "app" }}
      owner: {{ .Values.postgresql.user | default "app" }}
      secret:
        name: {{ include "common.fullname" . }}-superuser

  storage:
    size: {{ .Values.postgresql.storage.size | default "20Gi" }}
    storageClass: {{ .Values.postgresql.storage.storageClass | default "gp3" }}

  {{- if .Values.postgresql.backup.enabled }}
  backup:
    barmanObjectStore:
      destinationPath: s3://{{ .Values.postgresql.backup.s3Bucket }}/{{ include "common.fullname" . }}
      s3Credentials:
        inheritFromIAMRole: true
      wal:
        compression: gzip
        maxParallel: 8
    retentionPolicy: {{ .Values.postgresql.backup.retention | default "30d" }}
    {{- if .Values.postgresql.backup.schedule }}
    schedule: {{ .Values.postgresql.backup.schedule | quote }}
    {{- end }}
  {{- end }}

  resources:
    requests:
      cpu: {{ .Values.postgresql.resources.requests.cpu | default "250m" }}
      memory: {{ .Values.postgresql.resources.requests.memory | default "512Mi" }}
    limits:
      cpu: {{ .Values.postgresql.resources.limits.cpu | default "1000m" }}
      memory: {{ .Values.postgresql.resources.limits.memory | default "2Gi" }}

  monitoring:
    enablePodMonitor: true

  nodeMaintenanceWindow:
    inProgress: false
    reusePVC: true
{{- end }}
