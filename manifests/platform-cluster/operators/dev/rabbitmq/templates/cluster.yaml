apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: {{ .Values.clusterName }}
  namespace: {{ .Values.namespace }}
  labels:
    app: rabbitmq
    tenant: {{ .Values.tenant }}
    environment: {{ .Values.environment }}
    profile: nonprod
    managed-by: infraforge
spec:
  # Number of replicas
  replicas: {{ .Values.replicas }}

  # RabbitMQ image
  image: rabbitmq:{{ .Values.rabbitmqVersion }}-management

  # Service configuration
  service:
    type: {{ .Values.service.type }}

  # Persistence configuration
  persistence:
    storageClassName: {{ .Values.storage.storageClass }}
    storage: {{ .Values.storage.size }}

  # Resource limits
  resources:
    requests:
      cpu: {{ .Values.resources.requests.cpu }}
      memory: {{ .Values.resources.requests.memory }}
    limits:
      cpu: {{ .Values.resources.limits.cpu }}
      memory: {{ .Values.resources.limits.memory }}

  # RabbitMQ configuration
  rabbitmq:
    # Additional plugins
    additionalPlugins: {{- toYaml .Values.rabbitmq.additionalPlugins | nindent 6 }}

    # Additional configuration
    additionalConfig: |
{{- .Values.rabbitmq.additionalConfig | nindent 6 }}

  # Override default container settings
  override:
    statefulSet:
      spec:
        template:
          spec:
            containers:
              - name: rabbitmq
                env:
                  - name: RABBITMQ_DEFAULT_USER
                    valueFrom:
                      secretKeyRef:
                        name: {{ .Values.clusterName }}-default-user
                        key: username
                  - name: RABBITMQ_DEFAULT_PASS
                    valueFrom:
                      secretKeyRef:
                        name: {{ .Values.clusterName }}-default-user
                        key: password
