apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: kong
  annotations:
    konghq.com/gatewayclass-unmanaged: "true"
spec:
  controllerName: konghq.com/kic-gateway-controller

---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: platform-gateway
  namespace: default
spec:
  gatewayClassName: kong
  listeners:
  - name: http
    port: 80
    protocol: HTTP
    allowedRoutes:
      namespaces:
        from: All
  - name: https
    port: 443
    protocol: HTTPS
    tls:
      mode: Terminate
      certificateRefs:
      - name: platform-tls
        kind: Secret
    allowedRoutes:
      namespaces:
        from: All

---
# Example HTTPRoute for ArgoCD
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: argocd-route
  namespace: infraforge-argocd
spec:
  parentRefs:
  - name: platform-gateway
    namespace: default
  hostnames:
  - argocd.infraforge.io
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: argocd-server
      port: 80

---
# Example HTTPRoute for Grafana
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: grafana-route
  namespace: monitoring
spec:
  parentRefs:
  - name: platform-gateway
    namespace: default
  hostnames:
  - grafana.infraforge.io
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: prometheus-grafana
      port: 80

---
# Kong Plugin for rate limiting
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: rate-limiting
  namespace: default
plugin: rate-limiting
config:
  minute: 100
  hour: 10000
  policy: local

---
# Kong Plugin for authentication
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: jwt-auth
  namespace: default
plugin: jwt

---
# Kong Plugin for request/response transformation
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: request-transformer
  namespace: default
plugin: request-transformer
config:
  add:
    headers:
    - X-Platform:InfraForge
    - X-Environment:Production

---
# Kong Plugin for CORS
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: cors
  namespace: default
plugin: cors
config:
  origins:
  - "*"
  methods:
  - GET
  - POST
  - PUT
  - DELETE
  - OPTIONS
  headers:
  - Authorization
  - Content-Type
  exposed_headers:
  - X-Request-Id
  credentials: true
  max_age: 3600

---
# Kong Consumer for API authentication
apiVersion: configuration.konghq.com/v1
kind: KongConsumer
metadata:
  name: platform-admin
  namespace: default
  annotations:
    kubernetes.io/ingress.class: kong
username: admin
custom_id: platform-admin

---
# Kong Ingress for advanced configuration
apiVersion: configuration.konghq.com/v1
kind: KongIngress
metadata:
  name: platform-ingress
  namespace: default
proxy:
  connect_timeout: 10000
  retries: 10
  read_timeout: 10000
  write_timeout: 10000
upstream:
  slots: 1000
  hash_on: ip
  health_checks:
    active:
      type: http
      http_path: /health
      timeout: 5
      healthy:
        interval: 10
        successes: 3
      unhealthy:
        interval: 10
        http_failures: 3