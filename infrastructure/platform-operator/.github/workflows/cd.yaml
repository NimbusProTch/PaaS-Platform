name: CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/platform-operator
  HELM_CHART: platform-operator

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.platform.example.com
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_STAGING_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ secrets.STAGING_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

      - name: Deploy CRDs
        run: |
          kubectl apply -f config/crd/bases/

      - name: Deploy operator with Helm
        run: |
          helm upgrade --install ${{ env.HELM_CHART }} charts/platform-operator \
            --namespace platform-operator-system \
            --create-namespace \
            --set image.repository=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.sha }} \
            --set environment=staging \
            --set metrics.enabled=true \
            --set monitoring.prometheus.enabled=true \
            --set tracing.enabled=true \
            --wait --timeout 5m

      - name: Verify deployment
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=platform-operator -n platform-operator-system --timeout=300s
          kubectl get all -n platform-operator-system

      - name: Run smoke tests
        run: |
          make test-smoke

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://platform.example.com
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_PRODUCTION_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ secrets.PRODUCTION_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

      - name: Create backup
        run: |
          kubectl get applicationclaims.platform.infraforge.io -A -o yaml > backup-claims-$(date +%Y%m%d-%H%M%S).yaml
          kubectl get deployments -A -l platform.infraforge.io/managed=true -o yaml > backup-deployments-$(date +%Y%m%d-%H%M%S).yaml

      - name: Upload backup
        uses: actions/upload-artifact@v4
        with:
          name: production-backup-${{ github.sha }}
          path: backup-*.yaml
          retention-days: 30

      - name: Deploy CRDs with validation
        run: |
          kubectl apply -f config/crd/bases/ --dry-run=server
          kubectl apply -f config/crd/bases/

      - name: Deploy operator with Helm (Blue-Green)
        run: |
          # Deploy new version as blue
          helm upgrade --install ${{ env.HELM_CHART }}-blue charts/platform-operator \
            --namespace platform-operator-system \
            --create-namespace \
            --set image.repository=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.ref_name }} \
            --set environment=production \
            --set metrics.enabled=true \
            --set monitoring.prometheus.enabled=true \
            --set tracing.enabled=true \
            --set replicas=3 \
            --set resources.requests.memory=256Mi \
            --set resources.requests.cpu=100m \
            --set resources.limits.memory=512Mi \
            --set resources.limits.cpu=500m \
            --wait --timeout 10m

      - name: Run validation tests
        run: |
          make test-production

      - name: Switch traffic to blue
        run: |
          kubectl patch service platform-operator-webhook-service -n platform-operator-system \
            -p '{"spec":{"selector":{"version":"blue"}}}'

      - name: Monitor deployment
        run: |
          # Check metrics
          kubectl top pods -n platform-operator-system

          # Check for errors in logs
          kubectl logs -n platform-operator-system -l app.kubernetes.io/name=platform-operator --tail=100 | grep -i error || true

      - name: Cleanup old green deployment
        if: success()
        run: |
          helm uninstall ${{ env.HELM_CHART }}-green -n platform-operator-system || true

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          kubectl patch service platform-operator-webhook-service -n platform-operator-system \
            -p '{"spec":{"selector":{"version":"green"}}}'
          helm rollback ${{ env.HELM_CHART }}-blue -n platform-operator-system

  deploy-manual:
    name: Manual Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "ROLE_ARN=${{ secrets.AWS_PRODUCTION_ROLE_ARN }}" >> $GITHUB_ENV
            echo "CLUSTER_NAME=${{ secrets.PRODUCTION_CLUSTER_NAME }}" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "ROLE_ARN=${{ secrets.AWS_STAGING_ROLE_ARN }}" >> $GITHUB_ENV
            echo "CLUSTER_NAME=${{ secrets.STAGING_CLUSTER_NAME }}" >> $GITHUB_ENV
          else
            echo "ROLE_ARN=${{ secrets.AWS_DEVELOPMENT_ROLE_ARN }}" >> $GITHUB_ENV
            echo "CLUSTER_NAME=${{ secrets.DEVELOPMENT_CLUSTER_NAME }}" >> $GITHUB_ENV
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

      - name: Deploy operator
        run: |
          helm upgrade --install ${{ env.HELM_CHART }} charts/platform-operator \
            --namespace platform-operator-system \
            --create-namespace \
            --set image.repository=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.sha }} \
            --set environment=${{ github.event.inputs.environment }} \
            --wait --timeout 5m

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production, deploy-manual]
    if: always()
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Deployment Status: ${{ job.status }}
            Environment: ${{ github.event.inputs.environment || 'auto' }}
            Version: ${{ github.ref }}
            Actor: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()

      - name: Create GitHub issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment failed for ${context.sha}`,
              body: `Deployment failed in workflow ${context.workflow} run ${context.runId}`,
              labels: ['deployment-failure', 'urgent']
            })