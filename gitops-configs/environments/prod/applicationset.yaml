# ApplicationSet for Production Environments with Wave-based deployment
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: prod-apps
  namespace: argocd
spec:
  generators:
    - matrix:
        generators:
          # Environment generator
          - list:
              elements:
                - env: stage
                  namespace: stage
                  replicaMultiplier: "1"
                - env: prod
                  namespace: production
                  replicaMultiplier: "2"
          # Application generator with waves
          - list:
              elements:
                # Wave 1: Infrastructure components
                - appPath: components/postgresql
                  wave: "1"
                  type: infrastructure
                - appPath: components/redis
                  wave: "1"
                  type: infrastructure
                - appPath: components/rabbitmq
                  wave: "1"
                  type: infrastructure
                - appPath: components/kafka
                  wave: "1"
                  type: infrastructure
                - appPath: components/elasticsearch
                  wave: "1"
                  type: infrastructure
                - appPath: components/mongodb
                  wave: "1"
                  type: infrastructure

                # Wave 2: Core services
                - appPath: applications/auth-service
                  wave: "2"
                  type: application
                - appPath: applications/user-service
                  wave: "2"
                  type: application
                - appPath: applications/api-gateway
                  wave: "2"
                  type: application

                # Wave 3: Business services
                - appPath: applications/product-service
                  wave: "3"
                  type: application
                - appPath: applications/inventory-service
                  wave: "3"
                  type: application
                - appPath: applications/payment-service
                  wave: "3"
                  type: application
                - appPath: applications/order-service
                  wave: "3"
                  type: application
                - appPath: applications/shipping-service
                  wave: "3"
                  type: application

                # Wave 4: Communication services
                - appPath: applications/notification-service
                  wave: "4"
                  type: application
                - appPath: applications/email-service
                  wave: "4"
                  type: application
                - appPath: applications/sms-service
                  wave: "4"
                  type: application

                # Wave 5: Analytics and background jobs
                - appPath: applications/analytics-service
                  wave: "5"
                  type: application
                - appPath: applications/reporting-service
                  wave: "5"
                  type: application
                - appPath: applications/search-service
                  wave: "5"
                  type: application
                - appPath: applications/recommendation-service
                  wave: "5"
                  type: application
                - appPath: applications/scheduler-service
                  wave: "5"
                  type: application
                - appPath: applications/worker-service
                  wave: "5"
                  type: application

                # Wave 6: Frontend services
                - appPath: applications/web-frontend
                  wave: "6"
                  type: application
                - appPath: applications/mobile-bff
                  wave: "6"
                  type: application
                - appPath: applications/admin-panel
                  wave: "6"
                  type: application
  template:
    metadata:
      name: '{{env}}-{{appPath | basename}}'
      namespace: argocd
      annotations:
        argocd.argoproj.io/sync-wave: '{{wave}}'
      labels:
        environment: '{{env}}'
        type: '{{type}}'
    spec:
      project: platform
      source:
        repoURL: https://github.com/company/gitops-configs
        targetRevision: HEAD
        path: '{{appPath}}'
        helm:
          valueFiles:
            - values.yaml
            - values-{{env}}.yaml
          parameters:
            # Environment specific parameters
            - name: environment
              value: '{{env}}'
            - name: namespace
              value: '{{namespace}}'
            # Replica scaling based on environment
            - name: replicaCount
              value: "{{ if eq .type \"infrastructure\" }}3{{ else }}{{ mul .Values.replicaCount .replicaMultiplier }}{{ end }}"
            # Database configuration for applications
            - name: database.enabled
              value: "{{ if eq .type \"application\" }}true{{ else }}false{{ end }}"
            - name: database.host
              value: 'postgresql-{{env}}.{{namespace}}.svc.cluster.local'
            - name: database.port
              value: "5432"
            - name: database.name
              value: '{{appPath | basename}}_{{env}}'
            - name: database.username
              value: '{{appPath | basename}}'
            # Redis configuration for applications
            - name: redis.enabled
              value: "{{ if eq .type \"application\" }}true{{ else }}false{{ end }}"
            - name: redis.host
              value: 'redis-{{env}}.{{namespace}}.svc.cluster.local'
            - name: redis.port
              value: "6379"
            # RabbitMQ configuration
            - name: rabbitmq.host
              value: 'rabbitmq-{{env}}.{{namespace}}.svc.cluster.local'
            - name: rabbitmq.port
              value: "5672"
            # Kafka configuration
            - name: kafka.brokers
              value: 'kafka-{{env}}.{{namespace}}.svc.cluster.local:9092'
            # Elasticsearch configuration
            - name: elasticsearch.host
              value: 'elasticsearch-{{env}}.{{namespace}}.svc.cluster.local'
            - name: elasticsearch.port
              value: "9200"
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{namespace}}'
      syncPolicy:
        automated:
          prune: "{{ if eq .env \"prod\" }}false{{ else }}true{{ end }}"
          selfHeal: true
          allowEmpty: false
        syncOptions:
          - CreateNamespace=true
          - ApplyOutOfSyncOnly=true
          - RespectIgnoreDifferences=true
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 5m
      # Health checks for production
      {{ if eq .env "prod" }}
      ignoreDifferences:
        - group: apps
          kind: Deployment
          jsonPointers:
            - /spec/replicas
      {{ end }}